"use strict";(()=>{function d(t){t&&(t.classList.contains("cloak")||t.classList.add("cloak"))}function w(t){t&&t.classList.contains("cloak")&&t.classList.remove("cloak")}function _(){{let t=`.cloak { 
			opacity: 0;
			height: 0px;
      overflow: hidden;
			margin: 0;
		}`,e=document.createElement("style");e.textContent=t,document.head.appendChild(e)}}var D=(t,e=!0)=>t.cloneNode(e);var x=(t=document)=>t.documentElement.getAttribute("data-wf-site");function H(t,e,o){t&&(t.classList.add(e),setTimeout(function(){t.classList.remove(e)},o))}function I(t){let e=new Date(t);return isNaN(e.getTime())?"":e.toLocaleString("sv",{dateStyle:"short",timeStyle:"short"}).toString()}var l="data-dash-element",C={filter:"data-dash-counters-filter",firstRow:'[data-dash-element="counter-row"]',updateCounterValueInput:'[data-dash-element="update-counter-value-input"]',counterName:'[data-dash-element="counter-name"]',counterCount:'[data-dash-element="counter-count"]',counterUpdated:'[data-dash-element="counter-updated-date"]',updateButton:'[data-dash-element="update-button"]'},M=class{constructor(){this.list=document.querySelector('[data-dash-counters="list"]'),this.rowTemplate=document.querySelector('[data-dash-element="counter-row"]'),this.filter="data-dash-counters-filter",this.loadingRow=document.querySelector(`[${l}="loading-row"]`),this.updateCounterValueInput=document.querySelector(`[${l}="update-counter-value-input"]`),this.counterName=document.querySelector(`[${l}="counter-name"]`),this.counterCount=document.querySelector(`[${l}="counter-count"]`),this.counterUpdated=document.querySelector(`[${l}="counter-updated-date"]`),this.updateButton=document.querySelector(`[${l}="update-button"]`),this.newCounterButton=document.querySelector(`[${l}="new-counter-button"]`),this.statusBox=document.querySelector(`[${l}="status-box"]`),this.currentValueLabel=document.querySelector(`[${l}="current-value-label"]`),this.nameLabel=document.querySelector(`[${l}="name-label"]`),this.lastIncrementLabel=document.querySelector(`[${l}="last-increment-label"]`)}},S=class{constructor(){this.modalCard=document.querySelector(`[${l}="modal-card"]`),this.modalCloseButtons=document.querySelectorAll(`[${l}="close-button"]`),this.confirmUpdateBlock=document.querySelector(`[${l}="confirm-update-block"]`),this.confirmUpdateText=document.querySelector(`[${l}="confirm-text"]`),this.confirmUpdateButton=document.querySelector(`[${l}="confirm-button"]`),this.newCounterBlock=document.querySelector(`[${l}="new-counter-block"]`),this.confirmNewCounterButton=document.querySelector(`[${l}="confirm-new-counter-button"]`),this.newCounterValueInput=document.querySelector(`[${l}="new-counter-value-input"]`),this.newCounterNameInput=document.querySelector(`[${l}="new-counter-name-input"]`)}};var g={apiUrl:"https://utils-api.vercel.app/api/",counterPath:"counter/",gitHubUrl:"https://api.github.com/repos/ageraplattformen/agera.js/releases/latest",jsDelivrUrl:"https://data.jsdelivr.com/v1/packages/gh/ageraplattformen/agera.js/resolved?specifier=latest"};var b=class{async getList(e,o,i=100){let f=o.sort_by;o.sort_by==="count"&&(f="name");let E=`${g.apiUrl}counters${e}?sort_by=${f}&order=${o.order}&limit=${i}`;try{let s=await fetch(E);if(!s.ok)return s.status===404?N():N("Error getting data");let L=await s.json();return o.sort_by==="count"&&(o.order==="desc"?L.sort((T,v)=>v.count-T.count):L.sort((T,v)=>T.count-v.count)),L}catch{return N()}}async getInfo(e){let o=`${g.apiUrl}counter/${e}?info=true`;try{let i=await fetch(o);if(!i.ok)throw new Error("Error fetching data");return await i.json()}catch{throw new Error("Error fetching data")}}async put(e){let o=`${g.apiUrl}counter/${e.name}`;try{let i=await fetch(o,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok)throw new Error("Error fetching data");return i.json()}catch{throw new Error("Error fetching data")}}async post(e){let o=`${g.apiUrl}counter/${e.name}`;try{let i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok)return k();let f=await i.json();return f.details==="Created new counter"?f:k()}catch{return k()}}};function N(t="No counters found"){return[{count:0,name:t,last_updated:"",details:"",id:0,form:"",date_created:"",site_id:""}]}function k(){return{count:0,name:"No counters found",last_updated:"",details:"",id:0,form:"",date_created:"",site_id:""}}function q(){var U;let t=new M,e=new S,o=((U=t.list)==null?void 0:U.getAttribute(C.filter))||"",i={all:"",this:"/"+x()};i.hasOwnProperty(o)?o=i[o]:o!==""?o=`/${o}`:o=i.this;let f={sort_by:"name",order:"asc"},E=new b,s={name:"",newValue:0,oldValue:0,site_id:""};if(!t.rowTemplate)return;let L=t.rowTemplate.parentElement;t.rowTemplate.remove(),t.loadingRow&&w(t.loadingRow);let T;function v(u,r){let n=D(r),a=n.querySelector(C.counterName),c=n.querySelector(C.counterUpdated),p=n.querySelector('[data-dash-element="update-button"]'),m=n.querySelector(C.counterCount);if(u.name==="No counters found"){let h=n.querySelector(C.updateCounterValueInput);h&&h.remove(),p&&p.remove()}return a&&(a.textContent=u.name),c&&(u.last_updated?c.textContent=I(u.last_updated):c.textContent=I(u.date_created)),m&&(m.textContent=u.count.toString()),p&&m&&p.addEventListener("click",()=>{V(n,u,m)}),n}function V(u,r,n){var c;let a=u.querySelector(C.updateCounterValueInput);e.modalCard&&a&&(!Number.isNaN(parseInt(a.value))&&e.modalCard.classList.contains("cloak")?(s.name=r.name,s.site_id=r.site_id,s.newValue=parseInt(a.value),s.oldValue=parseInt(((c=n==null?void 0:n.textContent)==null?void 0:c.toString())||"0"),T=u,e.confirmUpdateText&&(e.confirmUpdateText.innerHTML=`Name: ${s.name}<br>Current value: ${s.oldValue}<br>New value: ${s.newValue}`),$("update")):H(a,"error",500))}function $(u){if(!e.modalCard)return;w(e.modalCard),e.confirmUpdateBlock&&e.confirmNewCounterButton&&(u==="update"?(w(e.confirmUpdateBlock),d(e.newCounterBlock),r()):u==="new"&&(w(e.newCounterBlock),d(e.confirmUpdateBlock),a())),e.modalCloseButtons.length>0&&e.modalCloseButtons.forEach(p=>{p.addEventListener("click",()=>{var m,h;d(e.modalCard),(m=e.confirmNewCounterButton)==null||m.removeEventListener("click",c),(h=e.confirmUpdateButton)==null||h.removeEventListener("click",n)})});function r(){e.confirmUpdateButton&&e.confirmUpdateButton.addEventListener("click",n)}async function n(){if(y("loading"),!!e.modalCard){if(d(e.modalCard),await E.put({name:s.name,count:s.newValue,site_id:s.site_id})){if(T){let p=T.querySelector(C.counterCount);p&&(p.textContent=s.newValue.toString())}y("updated")}else y("error");e.confirmUpdateButton&&e.confirmUpdateButton.removeEventListener("click",n)}}function a(){if(!e.confirmNewCounterButton||!e.newCounterValueInput||!e.newCounterNameInput){d(e.modalCard);return}e.confirmNewCounterButton.addEventListener("click",c)}async function c(){var h;if(!e.newCounterNameInput)return;if(!/^[a-z0-9-]{5,}$/.test(e.newCounterNameInput.value)){H(e.newCounterNameInput,"error",500);return}(h=e.confirmNewCounterButton)==null||h.removeEventListener("click",c),d(e.modalCard),y("loading");let m=await E.post({name:e.newCounterNameInput.value,site_id:x()||"0000"});if(m.id!==0){e.newCounterValueInput&&parseInt(e.newCounterValueInput.value)>0?m=await E.put({name:e.newCounterNameInput.value,count:parseInt(e.newCounterValueInput.value),site_id:x()||"0000"}):m=await E.getInfo(e.newCounterNameInput.value);let P=document.querySelector(C.firstRow);if(m&&t.rowTemplate){let B=v(m,t.rowTemplate);if(!L)return;L.insertBefore(B,P),w(B),H(B,"new",1e3)}y("created"),e.newCounterValueInput&&(e.newCounterValueInput.value=""),e.newCounterNameInput.value=""}else y("error")}}function y(u){let r=document.querySelector('[data-dash-element="status-box"]');if(!r)return;let n=r.childNodes[0],a=r.childNodes[1];a&&(u==="updated"?(n&&d(n),a.innerText="Updated"):u==="created"?(n&&d(n),a.innerText="Created"):u==="loading"?(d(a),n&&w(n)):(n&&d(n),a.innerText="Error",r.classList.add("error")),setTimeout(()=>{w(r),w(a)},100),setTimeout(function(){d(r),r.classList.remove("error")},3e3))}function j(){let u=[{element:t.nameLabel,sort_by:"name",order:"asc"},{element:t.lastIncrementLabel,sort_by:"last_updated",order:"asc"},{element:t.currentValueLabel,sort_by:"count",order:"desc"}],r=new URL(window.location.href);for(let n of u)if(n.element){let a=f.sort_by===n.sort_by&&f.order==="asc";r.searchParams.set("sort_by",n.sort_by),r.searchParams.set("order",a?"desc":"asc"),n.element.href=r.href}}function O(){t.newCounterButton&&t.newCounterButton.addEventListener("click",()=>{$("new")})}(async function(){f.sort_by=new URLSearchParams(window.location.search).get("sort_by")||"name",f.order=new URLSearchParams(window.location.search).get("order")||"asc";let r=await E.getList(o,f,100);if(!r)return;t.loadingRow&&r&&d(t.loadingRow);let n=t.rowTemplate;if(!n)return;let a=r.map(c=>v(c,n));L==null||L.append(...a),a.forEach((c,p)=>{setTimeout(function(){w(c)},10*p)}),j(),O()})()}function R(){_(),document.addEventListener("DOMContentLoaded",()=>{q()})}window.ageraDash||(window.ageraDash=!0,R());})();
